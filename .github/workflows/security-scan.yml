name: SAST, SCA & SBOM Scan

on:
  push:
    branches: ['*']
  pull_request:
    branches: [main]

jobs:
  # ----------------------
  # SAST: Semgrep
  # ----------------------
  sast-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Fresh Repo
        uses: actions/checkout@v4
        with:
          clean: true          # Forces fresh clone
          fetch-depth: 0       # Full history

      - name: Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto

  # ----------------------
  # SCA: Snyk (detailed output + fail on vulns)
  # ----------------------
  sca-scan:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    steps:
      - name: Checkout Fresh Repo
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'

      - name: Install dependencies
        run: npm ci

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Authenticate with Snyk
        run: snyk auth ${{ secrets.SNYK_TOKEN }}

      - name: Run Snyk SCA scan and show all vulnerabilities
        run: |
          echo "üîç Running Snyk test (show all vulnerabilities)..."
          snyk test --all-projects --severity-threshold=low --json > snyk-results.json || true

          echo "--------------------------------------"
          echo "üìã Detected Vulnerabilities Summary"
          echo "--------------------------------------"
          cat snyk-results.json | jq -r '
            .vulnerabilities[]? |
            "\(.title)\nSeverity: \(.severity | ascii_upcase)\nPackage: \(.packageName)@\(.version)\nDescription: \(.description)\n---"
          ' || echo "‚úÖ No vulnerabilities found."

          # Count vulnerabilities to decide whether to fail
          vulns=$(jq '.vulnerabilities | length' snyk-results.json)
          echo "Total vulnerabilities found: $vulns"
          if [ "$vulns" -gt 0 ]; then
            echo "‚ùå Vulnerabilities detected! Failing job..."
            exit 1
          else
            echo "‚úÖ No vulnerabilities detected!"
          fi

      - name: Upload full Snyk JSON report
        uses: actions/upload-artifact@v4
        with:
          name: snyk-sca-report
          path: ./frontend/snyk-results.json

  # ----------------------
  # SBOM: cdxgen
  # ----------------------
  sbom-generate:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    steps:
      - name: Checkout Fresh Repo
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'

      - run: npm ci

      - name: Install cdxgen
        run: npm install -g @cyclonedx/cdxgen

      - name: Generate SBOM
        run: cdxgen -o sbom.json

      - uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

  # ----------------------
  # E2E: Playwright UI tests
  # ----------------------
  playwright-e2e:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout Fresh Repo
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

    # Ensure Angular builds successfully
      - name: Build Angular app
        run: npm run build

      - name: Run Playwright E2E tests
        env:
          CI: true
        run: npx playwright test

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
